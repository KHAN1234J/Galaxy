<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Galaxy Raider - Mobile Space Shooter</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap');

        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #050510;
            font-family: 'Orbitron', sans-serif;
            touch-action: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        #gameCanvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .screen {
            pointer-events: auto;
            position: absolute;
            width: 100%;
            height: 100%;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            transition: opacity 0.3s ease;
            z-index: 10;
            padding: 20px;
            box-sizing: border-box;
        }

        .screen.active {
            display: flex;
        }

        #notifications {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 1000;
            pointer-events: none;
            width: 90%;
            max-width: 300px;
        }

        .notification {
            background: rgba(0, 0, 0, 0.95);
            border: 1px solid;
            padding: 12px 20px;
            color: #fff;
            font-size: 0.8rem;
            text-align: center;
            box-shadow: 0 0 15px rgba(0,0,0,0.8);
            animation: slideDown 0.3s ease-out, fadeOut 0.5s ease-in 2.5s forwards;
            border-radius: 4px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .notify-error { border-color: #ff0055; color: #ff0055; box-shadow: 0 0 10px rgba(255, 0, 85, 0.3); }
        .notify-success { border-color: #00ff00; color: #00ff00; box-shadow: 0 0 10px rgba(0, 255, 0, 0.3); }

        @keyframes slideDown { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }

        .btn {
            background: linear-gradient(180deg, rgba(0, 255, 255, 0.1), rgba(0, 255, 255, 0.05));
            border: 1px solid #00ffff;
            color: #00ffff;
            padding: 15px 30px;
            margin: 8px;
            font-family: 'Orbitron', sans-serif;
            font-size: 1rem; /* Adjusted for mobile */
            text-transform: uppercase;
            letter-spacing: 2px;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.1), inset 0 0 10px rgba(0, 255, 255, 0.05);
            clip-path: polygon(10% 0, 100% 0, 100% 70%, 90% 100%, 0 100%, 0 30%);
            width: 100%;
            max-width: 300px;
            text-align: center;
            position: relative;
            font-weight: 800;
            text-shadow: 0 0 5px rgba(0, 255, 255, 0.5);
        }

        .btn:active { transform: scale(0.95); background: rgba(0, 255, 255, 0.4); }

        .btn-red {
            border-color: #ff0055;
            color: #ff0055;
            background: rgba(255, 0, 85, 0.1);
            box-shadow: 0 0 15px rgba(255, 0, 85, 0.1);
            text-shadow: 0 0 5px rgba(255, 0, 85, 0.5);
        }
        .btn-red:active { background: rgba(255, 0, 85, 0.4); }

        .menu-panel {
            background: rgba(10, 15, 25, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-top: 3px solid #00ffff;
            border-bottom: 3px solid #00ffff;
            padding: 30px 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(15px);
            position: relative;
            border-radius: 4px;
            width: 100%;
            max-width: 500px;
        }

        .menu-panel::after {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.2) 50%, rgba(0,0,0,0.2));
            background-size: 100% 4px; pointer-events: none; opacity: 0.3;
        }
        
        .pause-btn {
            pointer-events: auto;
            background: rgba(0,0,0,0.5);
            border: 2px solid #00ffff;
            color: #00ffff;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            cursor: pointer;
            transition: 0.2s;
            font-weight: bold;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.2);
        }
        .pause-btn:active { transform: scale(0.9); background: #00ffff; color: #000; }

        .control-btn {
            pointer-events: auto;
            background: rgba(0, 0, 0, 0.6);
            border: 2px solid #555;
            color: #aaa;
            width: 70px; /* Larger for mobile */
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            cursor: pointer;
            transition: 0.2s;
            position: relative;
            backdrop-filter: blur(4px);
        }
        
        .control-btn.active {
            border-color: #00ffff; color: #00ffff; box-shadow: 0 0 20px rgba(0, 255, 255, 0.4);
            background: rgba(0, 40, 40, 0.8); transform: scale(1.05);
        }
        .control-btn:active { transform: scale(0.95); }
        
        .control-badge {
            position: absolute; top: 0; right: 0; background: #ff0055; color: white;
            border-radius: 50%; width: 24px; height: 24px; font-size: 0.8rem;
            display: flex; align-items: center; justify-content: center; border: 2px solid #222;
        }
        
        .key-hint { position: absolute; bottom: -20px; font-size: 0.7rem; color: #888; font-weight: bold; }
        .hud-text { text-shadow: 0 0 5px currentColor; }

        .shop-section { width: 100%; margin-bottom: 30px; }
        .shop-header { color: #00ffff; border-bottom: 1px solid rgba(0, 255, 255, 0.3); margin-bottom: 15px; padding-bottom: 5px; font-size: 1.1rem; letter-spacing: 2px; text-transform: uppercase; }
        
        /* Optimized Grid for Mobile */
        .shop-grid { 
            display: grid; 
            grid-template-columns: 1fr; /* Default single column for mobile */
            gap: 15px; 
            margin-bottom: 20px; 
        }
        @media (min-width: 640px) {
            .shop-grid { grid-template-columns: repeat(2, 1fr); }
        }

        .shop-item { border: 1px solid #333; padding: 20px; background: linear-gradient(135deg, rgba(20, 20, 25, 0.95) 0%, rgba(10, 10, 15, 0.98) 100%); display: flex; flex-direction: column; cursor: pointer; transition: 0.3s; position: relative; overflow: hidden; }
        .shop-item.selected { border-color: #00ff00; box-shadow: 0 0 20px rgba(0, 255, 0, 0.2); transform: translateY(-3px); }
        .shop-item.owned-pu { border-color: #d946ef; }
        .shop-item.locked { opacity: 0.6; filter: grayscale(0.8); }

        .stat-row { display: flex; align-items: center; margin-bottom: 4px; font-size: 0.7rem; color: #aaa; }
        .stat-label { width: 40px; text-align: right; margin-right: 8px; font-weight: bold; }
        .stat-track { flex-grow: 1; height: 4px; background: #333; border-radius: 2px; overflow: hidden; }
        .stat-fill { height: 100%; background: #00ffff; width: 0%; transition: width 0.5s ease-out; box-shadow: 0 0 5px #00ffff; }
        
        #boot-screen { background: #000; z-index: 100; }
        .loader-bar { width: 200px; height: 4px; background: #333; margin-top: 20px; position: relative; overflow: hidden; }
        .loader-progress { position: absolute; top: 0; left: 0; height: 100%; width: 0%; background: #00ffff; box-shadow: 0 0 10px #00ffff; animation: load 2s ease-in-out forwards; }
        @keyframes load { 0% { width: 0%; } 50% { width: 60%; } 100% { width: 100%; } }

        #level-notification {
            position: absolute; top: 30%; width: 100%; text-align: center; font-size: 4rem; font-weight: 900; color: #00ffff;
            text-shadow: 0 0 30px rgba(0, 255, 255, 0.8), 0 0 10px white;
            opacity: 0; pointer-events: none; transition: opacity 0.5s; z-index: 20; letter-spacing: 10px;
        }
        #level-notification.show { opacity: 1; animation: pulse-text 2s infinite; }
        @keyframes pulse-text { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

        .slider-container { width: 100%; margin: 15px 0; display: flex; flex-direction: column; align-items: flex-start; color: white; }
        .slider-label { margin-bottom: 8px; font-size: 0.9rem; color: #00ffff; text-transform: uppercase; letter-spacing: 1px; display: flex; justify-content: space-between; width: 100%; }
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]:focus { outline: none; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%; background: #00ffff; cursor: pointer; margin-top: -8px; box-shadow: 0 0 10px #00ffff; border: 2px solid #fff; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #333; border-radius: 2px; border: 1px solid #555; }
        
        .status-icon { display: flex; align-items: center; margin-right: 15px; font-size: 0.8rem; color: #fff; background: rgba(0,0,0,0.6); padding: 4px 8px; border: 1px solid #555; border-radius: 6px; box-shadow: 0 2px 10px rgba(0,0,0,0.3); margin-bottom: 5px;}

        #combo-container {
            position: absolute; top: 15%; left: 50%; transform: translateX(-50%);
            display: flex; flex-direction: column; align-items: center; opacity: 0; transition: opacity 0.3s;
        }
        #combo-container.active { opacity: 1; }
        #combo-count { font-size: 1.5rem; font-weight: 900; color: #ffd700; text-shadow: 0 0 15px rgba(255, 215, 0, 0.8); font-style: italic; }
        #combo-bar-bg { width: 150px; height: 6px; background: rgba(0,0,0,0.5); border: 1px solid #555; margin-top: 5px; border-radius: 3px; overflow: hidden; }
        #combo-bar-fill { height: 100%; background: linear-gradient(90deg, #ffaa00, #ffff00); width: 100%; transition: width 0.1s linear; }

        /* Responsive Text */
        .title-text { font-size: 2.5rem; }
        @media (min-width: 640px) { .title-text { font-size: 4rem; } }

    </style>
</head>
<body>

    <canvas id="gameCanvas"></canvas>

    <div id="ui-layer">
        
        <div id="notifications"></div>

        <div id="boot-screen" class="screen active">
            <h1 class="text-4xl md:text-6xl text-cyan-400 font-black tracking-widest mb-4 animate-pulse text-center">SYSTEM BOOT</h1>
            <div class="text-xs text-gray-500 font-mono mb-8">INITIALIZING GALAXY RAIDER OS v9.1...</div>
            <div class="loader-bar"><div class="loader-progress"></div></div>
            <div class="mt-8 text-gray-500 text-xs animate-pulse">TAP OR PRESS KEY TO START</div>
        </div>

        <div id="menu-screen" class="screen">
            <div class="menu-panel">
                <h1 class="title-text font-black text-transparent bg-clip-text bg-gradient-to-b from-cyan-300 via-cyan-500 to-blue-600 mb-2 filter drop-shadow-[0_0_15px_rgba(0,255,255,0.6)] tracking-tight text-center">GALAXY RAIDER</h1>
                <p class="text-cyan-200 mb-10 tracking-[0.2em] text-xs uppercase opacity-80 border-t border-cyan-900 pt-2 w-full text-center">Tactical Space Defense</p>
                <div class="flex flex-col gap-4 w-full items-center">
                    <button class="btn" onclick="game.start()">LAUNCH MISSION</button>
                    <button class="btn" onclick="game.openShop()">HANGAR BAY</button>
                    <button class="btn" onclick="game.openSettings()">SYSTEMS</button>
                    <button class="btn btn-red" onclick="game.exit()">EXIT SYSTEM</button>
                </div>
                <p id="high-score-display" class="mt-8 text-yellow-400 font-mono text-sm border border-yellow-900 bg-yellow-900/20 px-4 py-2 rounded">HIGH SCORE: 0</p>
            </div>
        </div>

        <div id="shop-screen" class="screen" style="justify-content: flex-start; padding-top: 20px; overflow-y: auto;">
            <div class="w-full max-w-4xl px-4 flex flex-col items-center">
                <div class="flex justify-between w-full max-w-[800px] items-end mb-6 border-b border-gray-700 pb-4 sticky top-0 bg-[#050510] z-10 pt-4">
                    <h2 class="text-2xl md:text-4xl text-white font-bold tracking-widest">HANGAR</h2>
                    <div class="text-yellow-400 text-lg md:text-xl font-bold bg-yellow-900/20 px-4 py-1 border border-yellow-700 rounded whitespace-nowrap">CR: <span id="shop-coins">0</span></div>
                </div>
                <div class="shop-section">
                    <div class="shop-header">FIGHTER CLASS (MAX LVL 3)</div>
                    <div id="ships-container" class="shop-grid"></div>
                </div>
                <div class="shop-section">
                    <div class="shop-header">TACTICAL UPGRADES</div>
                    <div id="powerups-container" class="shop-grid"></div>
                </div>
                <button class="btn btn-red mt-4 mb-12" onclick="game.openMenu()">RETURN TO MENU</button>
            </div>
        </div>

        <div id="settings-screen" class="screen">
            <div class="menu-panel w-full max-w-md">
                <h2 class="text-2xl md:text-3xl text-white mb-8 tracking-widest border-b border-gray-700 pb-4 w-full text-center">SYSTEM SETTINGS</h2>
                <div class="slider-container">
                    <div class="slider-label"><span>SFX VOLUME</span><span id="sfx-vol-val">50%</span></div>
                    <input type="range" id="sfx-slider" min="0" max="1" step="0.1" oninput="game.updateVolume('sfx')">
                </div>
                <div class="slider-container">
                    <div class="slider-label"><span>MUSIC VOLUME</span><span id="music-vol-val">50%</span></div>
                    <input type="range" id="music-slider" min="0" max="1" step="0.1" oninput="game.updateVolume('music')">
                </div>
                <div class="mt-8 text-xs text-gray-600 text-center">GALAXY RAIDER OS v9.1<br>AUTO-SAVE PROTOCOL: ACTIVE</div>
                <button class="btn btn-red mt-8" onclick="game.openMenu()">BACK</button>
            </div>
        </div>

        <div id="pause-screen" class="screen">
            <h2 class="text-4xl md:text-5xl text-cyan-400 font-bold mb-12 tracking-widest filter drop-shadow-[0_0_10px_rgba(0,255,255,0.5)]">SYSTEM PAUSED</h2>
            <button class="btn" onclick="game.togglePause()">RESUME</button>
            <button class="btn btn-red" onclick="game.quitToMenu()">ABORT MISSION</button>
        </div>

        <div id="hud" class="absolute top-0 left-0 w-full p-4 h-full pointer-events-none hidden">
            <div class="flex justify-between items-start w-full">
                <div class="flex flex-col">
                    <span class="text-white text-xl font-bold hud-text tracking-widest">SCORE: <span id="score-display">0</span></span>
                    <div class="w-32 md:w-48 h-3 bg-gray-900 border border-gray-600 mt-2 rounded-sm relative overflow-hidden box-shadow-[0_0_10px_rgba(0,0,0,0.5)]">
                        <div id="health-bar" class="absolute top-0 left-0 h-full bg-gradient-to-r from-green-600 to-green-400 transition-all duration-200" style="width: 100%"></div>
                    </div>
                    <div class="text-yellow-400 font-bold text-sm mt-2 hud-text">CREDITS: <span id="coin-display">0</span></div>
                    <div class="flex flex-col mt-3" id="status-hud"></div>
                </div>
                <div class="pause-btn" onclick="game.togglePause()">
                    <svg width="14" height="18" viewBox="0 0 14 18" fill="currentColor"><rect width="4" height="18" /><rect x="10" width="4" height="18" /></svg>
                </div>
            </div>
            <div id="combo-container"><div id="combo-count">COMBO x1</div><div id="combo-bar-bg"><div id="combo-bar-fill"></div></div></div>
            <div id="level-notification">LEVEL 1</div>
            <div id="active-controls" class="absolute bottom-6 right-6 flex flex-col gap-4 pointer-events-auto">
                <button id="btn-shield" class="control-btn" onclick="game.activatePowerup('shield')">
                    <span class="text-2xl">üõ°Ô∏è</span>
                    <span id="count-shield" class="control-badge">0</span>
                    <span class="key-hint hidden md:block">Q</span>
                </button>
                <button id="btn-laser" class="control-btn" onclick="game.activatePowerup('laser')">
                    <span class="text-2xl">‚ö°</span>
                    <span id="count-laser" class="control-badge">0</span>
                    <span class="key-hint hidden md:block">E</span>
                </button>
                <button id="btn-regen" class="control-btn" onclick="game.activatePowerup('regen')">
                    <span class="text-2xl">‚ûï</span>
                    <span id="count-regen" class="control-badge">0</span>
                    <span class="key-hint hidden md:block">R</span>
                </button>
            </div>
        </div>

        <div id="gameover-screen" class="screen">
            <div class="menu-panel border-red-500 border-t-2 border-b-2">
                <h1 class="text-4xl md:text-5xl text-red-500 font-black mb-2 tracking-widest text-center">CRITICAL FAILURE</h1>
                <p class="text-white text-xl mb-6 font-mono">SCORE: <span id="final-score" class="text-cyan-400">0</span></p>
                <div class="bg-gray-900/50 p-4 rounded border border-gray-700 mb-8 w-full text-center">
                    <p class="text-gray-400 text-xs uppercase mb-1">Salvage Value</p>
                    <p class="text-yellow-400 text-2xl font-bold">+<span id="coins-earned">0</span> CREDITS</p>
                </div>
                <button class="btn" onclick="game.start()">RETRY MISSION</button>
                <button class="btn btn-red" onclick="game.openMenu()">MAIN MENU</button>
            </div>
        </div>

        <div id="shutdown-screen" class="screen">
            <div class="text-center">
                <h1 class="text-3xl md:text-4xl text-gray-500 font-black tracking-widest mb-4">SYSTEM TERMINATED</h1>
                <p class="text-gray-600 text-sm">THANK YOU FOR PLAYING</p>
                <button class="btn mt-8" onclick="location.reload()">REBOOT SYSTEM</button>
            </div>
        </div>

    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // Game Constants & State - Moved to top to avoid initialization errors
        const GAME_STATE = { BOOT: 0, MENU: 1, PLAYING: 2, GAMEOVER: 3, PAUSED: 4 };
        let currentState = GAME_STATE.BOOT;
        let score = 0, frame = 0, level = 1, enemies = [], bullets = [], particles = [], drops = [], stars = [], floatingTexts = [], shake = 0, gridOffset = 0;
        let width, height;

        function resize() { 
            width = window.innerWidth; height = window.innerHeight; 
            canvas.width = width; canvas.height = height; 
            // Regenerate stars on resize to cover new area
            stars = [];
            for(let i=0; i<80; i++) { stars.push({ x: Math.random() * width, y: Math.random() * height, size: Math.random() * 2 + 0.5, speed: Math.random() * 2 + 0.5 }); }
        }
        window.addEventListener('resize', resize); 
        resize(); // Safe to call now

        const SaveSystem = {
            key: 'galaxy_raider_save_v15',
            data: {
                coins: 0, 
                highScore: 0,
                unlockedShips: [0],
                currentShip: 0,
                shipLevels: { 0: 1, 1: 1, 2: 1, 3: 1 }, 
                powerupLevels: { shield: 1, laser: 1, regen: 1 },
                inventory: { shield: 0, laser: 0, regen: 0 },
                settings: { sfxVolume: 0.5, musicVolume: 0.5 }
            },
            load() {
                const stored = localStorage.getItem(this.key);
                if (stored) {
                    try {
                        const parsed = JSON.parse(stored);
                        this.data = { ...this.data, ...parsed };
                        if (typeof this.data.settings.sfxVolume === 'undefined') this.data.settings.sfxVolume = 0.5;
                        if (typeof this.data.settings.musicVolume === 'undefined') this.data.settings.musicVolume = 0.5;
                        if(!this.data.inventory) this.data.inventory = { shield: 0, laser: 0, regen: 0 };
                        if(typeof this.data.inventory.regen === 'undefined') this.data.inventory.regen = 0;
                        if(!this.data.shipLevels) this.data.shipLevels = { 0: 1, 1: 1, 2: 1, 3: 1 };
                        if(!this.data.powerupLevels) this.data.powerupLevels = { shield: 1, laser: 1, regen: 1 };
                        if(typeof this.data.powerupLevels.regen === 'undefined') this.data.powerupLevels.regen = 1;
                    } catch (e) { console.error("Save error"); }
                }
                this.applySettingsUI();
            },
            save() { localStorage.setItem(this.key, JSON.stringify(this.data)); },
            applySettingsUI() {
                document.getElementById('sfx-slider').value = this.data.settings.sfxVolume;
                document.getElementById('music-slider').value = this.data.settings.musicVolume;
                document.getElementById('sfx-vol-val').innerText = Math.round(this.data.settings.sfxVolume * 100) + '%';
                document.getElementById('music-vol-val').innerText = Math.round(this.data.settings.musicVolume * 100) + '%';
            }
        };

        const AudioCtx = window.AudioContext || window.webkitAudioContext;
        let soundCtx = null;
        let musicInterval = null;
        let musicNodes = [];
        let masterGainNode = null, sfxGainNode = null, musicGainNode = null;

        const SoundManager = {
            init: () => {
                if(!soundCtx) {
                    soundCtx = new AudioCtx();
                    masterGainNode = soundCtx.createGain(); masterGainNode.connect(soundCtx.destination);
                    sfxGainNode = soundCtx.createGain(); sfxGainNode.connect(masterGainNode);
                    musicGainNode = soundCtx.createGain(); musicGainNode.connect(masterGainNode);
                    SoundManager.updateVolumes();
                }
                if(soundCtx.state === 'suspended') soundCtx.resume();
                if(SaveSystem.data.settings.musicVolume > 0 && musicNodes.length === 0) SoundManager.startMusic();
            },
            updateVolumes: () => {
                if(sfxGainNode) sfxGainNode.gain.setValueAtTime(SaveSystem.data.settings.sfxVolume, soundCtx.currentTime);
                if(musicGainNode) musicGainNode.gain.setValueAtTime(SaveSystem.data.settings.musicVolume * 0.5, soundCtx.currentTime); 
            },
            playTone: (freq, type, duration, volMultiplier = 1.0) => {
                if(!SaveSystem.data.settings.sfxVolume || !soundCtx) return;
                const osc = soundCtx.createOscillator(); const gain = soundCtx.createGain();
                osc.type = type; osc.frequency.setValueAtTime(freq, soundCtx.currentTime);
                gain.connect(sfxGainNode); osc.connect(gain);
                const finalVol = 0.2 * volMultiplier;
                gain.gain.setValueAtTime(finalVol, soundCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, soundCtx.currentTime + duration);
                osc.start(); osc.stop(soundCtx.currentTime + duration);
            },
            playShoot: () => { SoundManager.playTone(400, 'square', 0.15, 1.0); },
            playExplosion: () => {
                if(!SaveSystem.data.settings.sfxVolume || !soundCtx) return;
                const bufferSize = soundCtx.sampleRate * 0.5; const buffer = soundCtx.createBuffer(1, bufferSize, soundCtx.sampleRate);
                const data = buffer.getChannelData(0); for (let i = 0; i < bufferSize; i++) { data[i] = Math.random() * 2 - 1; }
                const noise = soundCtx.createBufferSource(); noise.buffer = buffer;
                const filter = soundCtx.createBiquadFilter(); filter.type = 'lowpass'; filter.frequency.value = 800;
                const gain = soundCtx.createGain(); gain.connect(sfxGainNode); noise.connect(filter); filter.connect(gain);
                gain.gain.setValueAtTime(0.8, soundCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, soundCtx.currentTime + 0.5);
                noise.start();
            },
            playPowerup: () => {
                if(!SaveSystem.data.settings.sfxVolume || !soundCtx) return;
                const osc = soundCtx.createOscillator(); const gain = soundCtx.createGain();
                gain.connect(sfxGainNode); osc.connect(gain);
                osc.type = 'sine'; osc.frequency.setValueAtTime(400, soundCtx.currentTime);
                osc.frequency.linearRampToValueAtTime(1200, soundCtx.currentTime + 0.3);
                gain.gain.setValueAtTime(0.3, soundCtx.currentTime); gain.gain.linearRampToValueAtTime(0, soundCtx.currentTime + 0.3);
                osc.start(); osc.stop(soundCtx.currentTime + 0.3);
            },
            playShieldHit: () => { SoundManager.playTone(150, 'sawtooth', 0.1, 0.5); },
            playUI: () => { SoundManager.playTone(800, 'sine', 0.05, 0.5); },
            playBeam: () => { SoundManager.playTone(100, 'sawtooth', 0.5, 1.5); },
            startMusic: () => {
                if(SaveSystem.data.settings.musicVolume <= 0 || !soundCtx) return;
                SoundManager.stopMusic();
                const createDrone = (freq, type, pan) => {
                    const osc = soundCtx.createOscillator(); const gain = soundCtx.createGain();
                    const panner = soundCtx.createStereoPanner(); const filter = soundCtx.createBiquadFilter();
                    osc.type = type; osc.frequency.setValueAtTime(freq, soundCtx.currentTime);
                    filter.type = 'lowpass'; filter.frequency.value = 600; panner.pan.value = pan;
                    gain.gain.setValueAtTime(0, soundCtx.currentTime); gain.gain.linearRampToValueAtTime(0.1, soundCtx.currentTime + 4); 
                    osc.connect(filter); filter.connect(panner); panner.connect(gain); gain.connect(musicGainNode); 
                    osc.start();
                    const node = { stop: () => { try { const t = soundCtx.currentTime; gain.gain.cancelScheduledValues(t); gain.gain.setValueAtTime(gain.gain.value, t); gain.gain.linearRampToValueAtTime(0, t + 2); osc.stop(t + 2.1); } catch(e) {} } };
                    musicNodes.push(node);
                };
                createDrone(73.42, 'sine', 0); createDrone(110.00, 'sine', -0.5); createDrone(130.81, 'triangle', 0.5); createDrone(174.61, 'sine', 0.2); 
                const playSparkle = () => {
                    if(SaveSystem.data.settings.musicVolume <= 0) return;
                    const t = soundCtx.currentTime; const osc = soundCtx.createOscillator();
                    const gain = soundCtx.createGain(); const panner = soundCtx.createStereoPanner();
                    osc.type = 'sine';
                    const notes = [587, 698, 880, 1046, 1174, 1396]; 
                    const freq = notes[Math.floor(Math.random() * notes.length)];
                    osc.frequency.setValueAtTime(freq, t);
                    gain.gain.setValueAtTime(0, t); gain.gain.linearRampToValueAtTime(0.05, t + 0.5); gain.gain.linearRampToValueAtTime(0, t + 2.5); 
                    panner.pan.value = Math.random() * 2 - 1;
                    osc.connect(panner); panner.connect(gain); gain.connect(musicGainNode);
                    osc.start(t); osc.stop(t + 2.5);
                };
                musicInterval = setInterval(playSparkle, 3000);
            },
            stopMusic: () => {
                if(musicInterval) clearInterval(musicInterval);
                musicNodes.forEach(node => { try { node.stop(); } catch(e) {} });
                musicNodes = [];
            }
        };

        const SHIPS = [
            { 
                id: 0, name: "ALPHA WING", cost: 0, color: "#00ffff", speed: 1.0, fireRate: 15, health: 100, damage: 1,
                desc: "Balanced stats. Reliable standard issue fighter.",
                svg: `<path d="M25 5 L45 45 L25 35 L5 45 Z" fill="#00ffff" stroke="white" stroke-width="1"/>`,
                maxLevel: 3, upgradeCost: 500
            },
            { 
                id: 1, name: "STRIKER X", cost: 500, color: "#00ff00", speed: 1.3, fireRate: 10, health: 80, damage: 1,
                desc: "High mobility and rapid fire. Sacrifices armor.",
                svg: `<path d="M25 5 L35 20 L45 10 L40 45 L25 35 L10 45 L5 10 L15 20 Z" fill="#00ff00" stroke="white" stroke-width="1"/>`,
                maxLevel: 3, upgradeCost: 800
            },
            { 
                id: 2, name: "TITAN HEAVY", cost: 1500, color: "#ffd700", speed: 0.7, fireRate: 24, health: 200, damage: 2,
                desc: "Heavily armored hull. Fires powerful Pulse Lasers.",
                svg: `<path d="M20 5 L30 5 L45 20 L45 45 L35 40 L15 40 L5 45 L5 20 Z" fill="#ffd700" stroke="white" stroke-width="1"/>`,
                maxLevel: 3, upgradeCost: 1500
            },
            { 
                id: 3, name: "PHANTOM", cost: 3000, color: "#9933ff", speed: 1.5, fireRate: 8, health: 60, damage: 1,
                desc: "Extreme speed stealth craft. Triple-gun configuration.",
                svg: `<path d="M25 0 L30 15 L48 20 L40 45 L25 35 L10 45 L2 20 L20 15 Z" fill="#9933ff" stroke="white" stroke-width="1"/>`,
                maxLevel: 3, upgradeCost: 2500
            }
        ];
        const POWERUPS = [
            { id: 'shield', name: "FORCE SHIELD", cost: 50, color: "#00ffff", desc: "Absorbs damage. Upgrade for more durability.", icon: "üõ°Ô∏è", maxLevel: 3, upgradeCost: 1500 },
            { id: 'laser', name: "PLASMA BEAM", cost: 100, color: "#ff00ff", desc: "High-power laser. Upgrade for longer duration.", icon: "‚ö°", maxLevel: 3, upgradeCost: 2000 },
            { id: 'regen', name: "NANO REPAIR", cost: 75, color: "#00ff00", desc: "Restores Hull Integrity. Upgrade for more healing.", icon: "‚ûï", maxLevel: 3, upgradeCost: 1200 }
        ];

        
        const player = { x: 0, y: 0, radius: 25, targetX: 0, targetY: 0, hp: 100, maxHp: 100, lastShot: 0, config: SHIPS[0], shieldHp: 0, laserTimer: 0, scoreMult: 1, scoreMultTimer: 0, combo: 0, comboTimer: 0, damage: 1 };
        let touchActive = false;
        
        const input = { keys: {}, gamepadIndex: null };
        window.addEventListener('keydown', e => {
            input.keys[e.key.toLowerCase()] = true; input.keys[e.code] = true;
            if (e.key === 'Escape' || e.key.toLowerCase() === 'p') game.togglePause();
            if (e.key === 'q' || e.key === '1') game.activatePowerup('shield');
            if (e.key === 'e' || e.key === '2') game.activatePowerup('laser');
            if (e.key === 'r' || e.key === '3') game.activatePowerup('regen');
        });
        window.addEventListener('keyup', e => { input.keys[e.key.toLowerCase()] = false; input.keys[e.code] = false; });
        window.addEventListener('gamepadconnected', e => { input.gamepadIndex = e.gamepad.index; });
        window.addEventListener('gamepaddisconnected', () => { input.gamepadIndex = null; });

        class FloatingText {
            constructor(x, y, text, color, size = 20) { this.x = x; this.y = y; this.text = text; this.color = color; this.size = size; this.life = 1.0; this.vy = -3; }
            update() { this.y += this.vy; this.life -= 0.02; }
            draw() { ctx.globalAlpha = Math.max(0, this.life); ctx.fillStyle = this.color; ctx.font = `bold ${this.size}px Orbitron`; ctx.textAlign = "center"; ctx.fillText(this.text, this.x, this.y); ctx.globalAlpha = 1.0; }
        }

        class PowerupDrop {
            constructor(x, y, type) {
                this.x = x; this.y = y; this.type = type; this.r = 15; this.speed = 2;
                if (type === 'shield') { this.icon = 'üõ°Ô∏è'; this.color = '#00ffff'; } else if (type === 'laser') { this.icon = '‚ö°'; this.color = '#ff00ff'; } else if (type === 'multiplier') { this.icon = 'X2'; this.color = '#ffd700'; } else if (type === 'regen') { this.icon = '‚ûï'; this.color = '#00ff00'; }
            }
            update() { this.y += this.speed; this.x += Math.sin(this.y * 0.05) * 1; }
            draw() { ctx.shadowBlur = 10; ctx.shadowColor = this.color; ctx.fillStyle = "rgba(0,0,0,0.5)"; ctx.beginPath(); ctx.arc(this.x, this.y, this.r, 0, Math.PI*2); ctx.fill(); ctx.strokeStyle = this.color; ctx.lineWidth = 2; ctx.stroke(); ctx.shadowBlur = 0; ctx.fillStyle = "#fff"; ctx.font = "16px Arial"; ctx.textAlign = "center"; ctx.textBaseline = "middle"; ctx.fillText(this.icon, this.x, this.y); }
        }

        class Enemy {
            constructor(x, y, typeOverride) {
                const difficultyMultiplier = Math.min(3, 1 + (score / 2000) + (level * 0.2));
                if (typeOverride === 'swarm') { 
                    this.x = x; this.y = y; this.type = 'swarm'; this.hp = 1; 
                    // Reduced speed for swarm
                    this.speed = (2.0 + Math.random()) * difficultyMultiplier; 
                    this.r = 12; this.color = '#ff9900'; this.scoreVal = 5; this.fireRate = Infinity; this.bulletSpeed = 0; return; 
                }
                this.x = Math.random() * (width - 40) + 20; this.y = -60; this.lastShot = frame + Math.random() * 60;
                let type = 'scout'; const roll = Math.random();
                if (score > 1500 || level > 2) { if (roll < 0.4) type = 'scout'; else if (roll < 0.8) type = 'fighter'; else type = 'tank'; } else if (score > 500 || level > 1) { if (roll < 0.6) type = 'scout'; else type = 'fighter'; } else { type = 'scout'; }
                
                // Reduced Speeds for all enemies
                if (type === 'scout') { this.type = 'scout'; this.hp = 1 * difficultyMultiplier; this.speed = (1.5 + Math.random()) * difficultyMultiplier; this.r = 20; this.color = '#ff69b4'; this.scoreVal = 10; this.fireRate = 80; this.bulletSpeed = 6; } 
                else if (type === 'fighter') { this.type = 'fighter'; this.hp = 2 * difficultyMultiplier; this.speed = (1.2 + Math.random()) * difficultyMultiplier; this.r = 25; this.color = '#ff0000'; this.scoreVal = 25; this.fireRate = 50; this.bulletSpeed = 8; } 
                else { this.type = 'tank'; this.hp = 8 * difficultyMultiplier; this.speed = 0.6 * difficultyMultiplier; this.r = 40; this.color = '#cc0000'; this.scoreVal = 100; this.fireRate = 180; this.bulletSpeed = 12; }
                this.speed = Math.min(this.speed, 8);
            }
            update() {
                this.y += this.speed;
                if (this.type === 'swarm') { this.x += Math.sin(this.y * 0.1) * 2; } 
                else {
                    this.x += Math.sin(this.y * 0.02) * (this.type === 'scout' ? 1.5 : 0.5);
                    if (frame > this.lastShot + this.fireRate) {
                        if (this.y > 0 && this.y < height) {
                            if(this.type === 'tank') { SoundManager.playBeam(); bullets.push(new Bullet(this.x, this.y + this.r, this.bulletSpeed, '#ff0000', false, false, true)); } 
                            else { SoundManager.playShoot(); bullets.push(new Bullet(this.x, this.y + this.r, this.bulletSpeed, '#ff0055', false)); }
                            this.lastShot = frame;
                        }
                    }
                }
            }
            draw() {
                ctx.save(); ctx.translate(this.x, this.y); ctx.shadowBlur = 10; ctx.shadowColor = this.color; ctx.fillStyle = this.color;
                ctx.beginPath();
                if (this.type === 'swarm') { ctx.moveTo(0, -this.r); ctx.lineTo(this.r, 0); ctx.lineTo(0, this.r * 1.5); ctx.lineTo(-this.r, 0); ctx.moveTo(0, -this.r/2); ctx.lineTo(0, this.r); } 
                else if (this.type === 'scout') { ctx.moveTo(0, this.r); ctx.lineTo(-this.r, -this.r/2); ctx.lineTo(0, -this.r); ctx.lineTo(this.r, -this.r/2); ctx.fillStyle = this.color; } 
                else if (this.type === 'fighter') { ctx.moveTo(0, this.r); ctx.lineTo(this.r/2, 0); ctx.lineTo(this.r, -this.r); ctx.lineTo(this.r/4, -this.r/2); ctx.lineTo(-this.r/4, -this.r/2); ctx.lineTo(-this.r, -this.r); ctx.lineTo(-this.r/2, 0); } 
                else { ctx.moveTo(-this.r/2, this.r); ctx.lineTo(this.r/2, this.r); ctx.lineTo(this.r, 0); ctx.lineTo(this.r*0.8, -this.r); ctx.lineTo(-this.r*0.8, -this.r); ctx.lineTo(-this.r, 0); ctx.rect(-this.r/3, -this.r/2, this.r*0.66, this.r); }
                ctx.fill(); ctx.strokeStyle = "rgba(255,255,255,0.4)"; ctx.lineWidth = 1; ctx.stroke();
                ctx.fillStyle = "#ffffff"; ctx.beginPath(); if(this.type === 'tank') ctx.arc(0, 0, 5, 0, Math.PI*2); else ctx.arc(0, -5, 2, 0, Math.PI*2); ctx.fill(); ctx.restore();
            }
        }

        class Bullet {
            constructor(x, y, speed, color, isPlayer, isLaser = false, isBeam = false, damage = 1, width = 3, height = 8) { 
                this.x = x; this.y = y; this.speed = speed; 
                this.r = width; // Radius/Width
                this.len = height; // Length
                this.color = color; this.isPlayer = isPlayer; this.isLaser = isLaser; this.isBeam = isBeam; this.damage = damage; this.hp = isLaser ? 3 : 1; this.angle = 0; 
            }
            update() { this.y += this.isPlayer ? -this.speed : this.speed; this.angle += 0.2; }
            draw() {
                ctx.fillStyle = this.color; ctx.shadowBlur = (this.isPlayer || this.isBeam) ? 15 : 5; ctx.shadowColor = this.color;
                if (this.isPlayer) {
                    if (this.isLaser) { 
                        ctx.beginPath(); ctx.ellipse(this.x, this.y, this.r, this.r * 4, 0, 0, Math.PI * 2); ctx.fill(); 
                        ctx.fillStyle = '#ffffff'; ctx.beginPath(); ctx.ellipse(this.x, this.y, this.r/2, this.r * 3, 0, 0, Math.PI * 2); ctx.fill(); 
                    } 
                    else if (this.r > 6) { 
                         // TITAN PULSE (Large)
                         ctx.shadowColor = "#00ffff"; ctx.fillStyle = "#e0ffff"; 
                         ctx.beginPath(); 
                         // Draw larger ellipse based on dynamic width/length
                         ctx.ellipse(this.x, this.y, this.r, this.len, 0, 0, Math.PI*2); 
                         ctx.fill();
                         // Core
                         ctx.fillStyle = "#ffffff"; ctx.shadowBlur = 0;
                         ctx.beginPath(); ctx.ellipse(this.x, this.y, this.r/2, this.len/1.5, 0, 0, Math.PI*2); ctx.fill();
                    }
                    else { 
                        // Standard Bullet
                        ctx.beginPath(); ctx.roundRect(this.x - this.r, this.y - this.len, this.r*2, this.len*2, 3); ctx.fill(); 
                    }
                } else {
                    if (this.isBeam) { ctx.save(); ctx.translate(this.x, this.y); ctx.fillStyle = "#ff0000"; ctx.beginPath(); ctx.roundRect(-10, -50, 20, 100, 10); ctx.fill(); ctx.shadowBlur = 20; ctx.shadowColor = "#8b0000"; ctx.strokeStyle = "#ffffff"; ctx.lineWidth = 2; ctx.stroke(); ctx.restore(); } 
                    else { ctx.save(); ctx.translate(this.x, this.y); ctx.rotate(frame * 0.1); ctx.beginPath(); ctx.moveTo(0, -8); ctx.lineTo(6, 0); ctx.lineTo(0, 8); ctx.lineTo(-6, 0); ctx.closePath(); ctx.fill(); ctx.restore(); }
                }
                ctx.shadowBlur = 0;
            }
        }

        class Particle {
            constructor(x, y, color, isSpark = false) { 
                this.x = x; this.y = y; 
                this.vx = (Math.random() - 0.5) * (isSpark ? 15 : 10); 
                this.vy = (Math.random() - 0.5) * (isSpark ? 15 : 10); 
                this.life = 1.0; this.color = color; this.isSpark = isSpark;
                this.decay = Math.random() * 0.05 + 0.02;
            }
            update() { 
                this.x += this.vx; this.y += this.vy; 
                this.vx *= 0.92; this.vy *= 0.92; // Friction
                this.life -= this.decay; 
            }
            draw() { 
                ctx.globalAlpha = Math.max(0, this.life); 
                ctx.fillStyle = this.color; 
                ctx.beginPath(); 
                ctx.globalCompositeOperation = 'lighter';
                ctx.arc(this.x, this.y, this.isSpark ? 2 : 4 * this.life, 0, Math.PI*2); 
                ctx.fill(); 
                ctx.globalCompositeOperation = 'source-over';
                ctx.globalAlpha = 1.0; 
            }
        }

        let swarmTimer = 0;
        function spawnEntities() {
            const spawnMod = Math.max(0.5, 1.0 - (level * 0.05)); 
            swarmTimer++;
            if (swarmTimer > 400 * spawnMod) {
                swarmTimer = 0; const formation = Math.random() > 0.5 ? 'line' : 'circle';
                if (formation === 'line') { const count = 5 + Math.floor(Math.random() * 3); const gap = width / (count + 1); for(let i=0; i<count; i++) { enemies.push(new Enemy((i+1)*gap, -50, 'swarm')); } } 
                else { const cx = Math.random() * (width - 150) + 75; const radius = 60; for(let i=0; i<8; i++) { const angle = (i / 8) * Math.PI * 2; enemies.push(new Enemy(cx + Math.cos(angle)*radius, -50 + Math.sin(angle)*radius, 'swarm')); } }
            }
            const scoreFactor = Math.min(50, score/100); const baseRate = Math.max(10, Math.floor((60 - scoreFactor) * spawnMod));
            if (frame % baseRate === 0) { enemies.push(new Enemy()); }
        }

        function handleInput() {
            let dx = 0, dy = 0; const moveSpeed = 12; 
            if (input.keys['w'] || input.keys['arrowup']) dy -= 1; if (input.keys['s'] || input.keys['arrowdown']) dy += 1; if (input.keys['a'] || input.keys['arrowleft']) dx -= 1; if (input.keys['d'] || input.keys['arrowright']) dx += 1;
            if (input.gamepadIndex !== null) { const gp = navigator.getGamepads()[input.gamepadIndex]; if (gp) { if (Math.abs(gp.axes[0]) > 0.2) dx += gp.axes[0]; if (Math.abs(gp.axes[1]) > 0.2) dy += gp.axes[1]; if (gp.buttons[2].pressed && frame % 10 === 0) game.activatePowerup('shield'); if (gp.buttons[3].pressed && frame % 10 === 0) game.activatePowerup('laser'); if (gp.buttons[1].pressed && frame % 10 === 0) game.activatePowerup('regen'); if (gp.buttons[9].pressed && frame % 30 === 0) game.togglePause(); } }
            if (dx !== 0 || dy !== 0) { const len = Math.hypot(dx, dy); if (len > 1) { dx /= len; dy /= len; } player.targetX += dx * moveSpeed; player.targetY += dy * moveSpeed; player.targetX = Math.max(player.radius, Math.min(width - player.radius, player.targetX)); player.targetY = Math.max(player.radius, Math.min(height - player.radius, player.targetY)); }
        }

        function update() {
            if (currentState !== GAME_STATE.PLAYING) return;
            frame++; if (shake > 0) shake *= 0.9;
            if (player.laserTimer > 0) player.laserTimer--;
            if (player.scoreMultTimer > 0) { player.scoreMultTimer--; if(player.scoreMultTimer <= 0) { player.scoreMult = 1; updateHUD(); } }
            if(player.comboTimer > 0) { player.comboTimer--; if(player.comboTimer <= 0) { player.combo = 0; updateHUD(); } }
            const requiredScore = level * 1500; if (score > requiredScore) { game.levelUp(); }

            handleInput(); spawnEntities();

            // Calculate movement delta for animation
            const dx = player.targetX - player.x;
            const dy = player.targetY - player.y;

            player.x += dx * 0.15; // Slightly smoother lerp
            player.y += dy * 0.15;
            
            if(player.x < player.radius) player.x = player.radius; if(player.x > width - player.radius) player.x = width - player.radius; if(player.y < player.radius) player.y = player.radius; if(player.y > height - player.radius) player.y = height - player.radius;

            // --- IMPROVED ENGINE TRAILS ---
            if (frame % 2 === 0) {
                // Main Thruster
                particles.push(new Particle(player.x + (Math.random()-0.5)*4, player.y + player.radius*0.8, player.config.color, 'trail'));
                
                // Wing trails for certain ships
                if (player.config.id === 1 || player.config.id === 3) {
                    particles.push(new Particle(player.x - 15, player.y + 10, player.config.color, 'trail'));
                    particles.push(new Particle(player.x + 15, player.y + 10, player.config.color, 'trail'));
                }
            }

            const fireRate = player.laserTimer > 0 ? 5 : player.config.fireRate; 
            if (frame - player.lastShot > fireRate) {
                SoundManager.playShoot();
                const isLaser = player.laserTimer > 0; const color = isLaser ? '#ff00ff' : '#ffff00'; const speed = isLaser ? 25 : 15;
                const dmg = player.damage;
                const shipLevel = SaveSystem.data.shipLevels[player.config.id];

                // Calculate Bullet Size
                let bW = 3; // Default radius (width = 6)
                let bH = 8; // Default length
                
                if (player.config.id === 2) { 
                    // TITAN: Double width + Scaling with Level
                    // Base width: 8 (Total width 16px). Height 20.
                    // Increases by 2px radius and 5px length per level
                    bW = 8 + (shipLevel - 1) * 2; 
                    bH = 20 + (shipLevel - 1) * 5;
                }

                if (player.config.id === 3) { 
                    bullets.push(new Bullet(player.x, player.y - player.radius, speed, color, true, isLaser, false, dmg, bW, bH)); 
                    bullets.push(new Bullet(player.x - 20, player.y + 10, speed, color, true, isLaser, false, dmg, bW, bH)); 
                    bullets.push(new Bullet(player.x + 20, player.y + 10, speed, color, true, isLaser, false, dmg, bW, bH)); 
                } 
                else { 
                    bullets.push(new Bullet(player.x, player.y - player.radius, speed, color, true, isLaser, false, dmg, bW, bH)); 
                }
                player.lastShot = frame;
            }

            for (let i = bullets.length - 1; i >= 0; i--) {
                let b = bullets[i]; b.update();
                if (b.y < -50 || b.y > height + 50) { bullets.splice(i, 1); continue; }
                if (b.isPlayer) {
                    let hit = false;
                    for (let j = enemies.length - 1; j >= 0; j--) {
                        let e = enemies[j];
                        let dist = Math.hypot(e.x - b.x, e.y - b.y);
                        if (dist < e.r + b.r) {
                            const damageDealt = b.isLaser ? 3 : b.damage;
                            enemies[j].hp -= damageDealt; createExplosion(b.x, b.y, '#ffff00', 3, true); 
                            if (b.isLaser) { b.hp--; if(b.hp <= 0) hit = true; } else { hit = true; }
                            if (enemies[j].hp <= 0) {
                                SoundManager.playExplosion(); player.combo++; player.comboTimer = 180; 
                                let val = Math.floor(e.scoreVal * player.scoreMult * (player.combo > 5 ? 1.5 : 1));
                                score += val; floatingTexts.push(new FloatingText(e.x, e.y, "+" + val, '#ffff00'));
                                if (e.type === 'tank') { drops.push(new PowerupDrop(e.x, e.y, 'multiplier')); } 
                                else if (Math.random() < 0.05) { const r = Math.random(); let pType = 'shield'; if(r<0.33) pType = 'shield'; else if(r<0.66) pType = 'laser'; else pType = 'regen'; drops.push(new PowerupDrop(e.x, e.y, pType)); }
                                enemies.splice(j, 1); createExplosion(e.x, e.y, e.color, 15); updateHUD(); triggerShake(8);
                            }
                            break; 
                        }
                    }
                    if (hit) bullets.splice(i, 1);
                } else {
                    let pDist = Math.hypot(player.x - b.x, player.y - b.y);
                    if (pDist < player.radius + b.r) { bullets.splice(i, 1); damagePlayer(b.isBeam ? 30 : 10); continue; }
                }
            }

            for (let i = enemies.length - 1; i >= 0; i--) {
                let e = enemies[i]; e.update();
                let pDist = Math.hypot(e.x - player.x, e.y - player.y);
                if (pDist < e.r + player.radius) {
                    if (player.shieldHp > 0) { let val = (e.scoreVal + 5) * player.scoreMult; score += val; floatingTexts.push(new FloatingText(e.x, e.y, "+" + val, '#00ffff')); }
                    enemies.splice(i, 1); SoundManager.playExplosion(); createExplosion(e.x, e.y, '#ff0000', 15); damagePlayer(20); updateHUD(); continue;
                }
                if (e.y > height + 50) enemies.splice(i, 1);
            }

            for (let i = drops.length - 1; i >= 0; i--) {
                let d = drops[i]; d.update();
                let dist = Math.hypot(d.x - player.x, d.y - player.y);
                if (dist < player.radius + d.r) {
                    SoundManager.playPowerup();
                    if (d.type === 'multiplier') { player.scoreMult = 2; player.scoreMultTimer = 900; createExplosion(d.x, d.y, '#ffd700', 15); floatingTexts.push(new FloatingText(d.x, d.y, "DOUBLE SCORE!", '#ffd700', 30)); } 
                    else { SaveSystem.data.inventory[d.type]++; createExplosion(d.x, d.y, d.color, 10); floatingTexts.push(new FloatingText(d.x, d.y, d.type.toUpperCase(), d.color)); }
                    drops.splice(i, 1); updateHUD(); 
                } else if (d.y > height + 50) { drops.splice(i, 1); }
            }

            for (let i = particles.length - 1; i >= 0; i--) { particles[i].update(); if (particles[i].life <= 0) particles.splice(i, 1); }
            for (let i = floatingTexts.length - 1; i >= 0; i--) { floatingTexts[i].update(); if (floatingTexts[i].life <= 0) floatingTexts.splice(i, 1); }
            stars.forEach(s => { s.y += s.speed; if (s.y > height) { s.y = 0; s.x = Math.random() * width; } });
        }

        function damagePlayer(amount) {
            if (player.shieldHp > 0) { SoundManager.playShieldHit(); player.shieldHp--; createExplosion(player.x, player.y, '#00ffff', 10, 'spark'); floatingTexts.push(new FloatingText(player.x, player.y, "SHIELD HIT", '#00ffff', 15)); updateHUD(); triggerShake(10); } 
            else { player.hp -= amount; createExplosion(player.x, player.y, '#ff0000', 10, 'spark'); floatingTexts.push(new FloatingText(player.x, player.y, "-" + amount, '#ff0000', 25)); triggerShake(20); updateHUD(); if (player.hp <= 0) gameOver(); }
        }

        function draw() {
            ctx.save();
            if (shake > 0.5) { ctx.translate((Math.random() - 0.5) * shake, (Math.random() - 0.5) * shake); }
            ctx.fillStyle = '#050510'; ctx.fillRect(-20, -20, width+40, height+40);
            ctx.fillStyle = '#ffffff'; stars.forEach(s => { ctx.globalAlpha = Math.random() * 0.5 + 0.3; ctx.beginPath(); ctx.arc(s.x, s.y, s.size, 0, Math.PI*2); ctx.fill(); }); ctx.globalAlpha = 1.0;

            if (currentState === GAME_STATE.PLAYING || currentState === GAME_STATE.PAUSED) {
                drops.forEach(d => d.draw());
                
                // --- PLAYER RENDER ---
                ctx.save(); 
                ctx.translate(player.x, player.y);
                
                // Banking Animation: Rotate based on horizontal movement target difference
                const dx = (player.targetX - player.x);
                const tilt = dx * 0.005; // Amount of tilt
                const maxTilt = 0.4;
                const clampedTilt = Math.max(-maxTilt, Math.min(maxTilt, tilt));
                ctx.rotate(clampedTilt);
                
                // Roll Effect: Compress width slightly based on tilt to simulate 3D turn
                const scaleX = 1.0 - Math.abs(clampedTilt) * 0.3;
                ctx.scale(scaleX, 1.0);

                // Dynamic Engine Flare
                // Grows when moving up (dy < 0), shrinks when moving down (dy > 0)
                const dy = (player.targetY - player.y);
                const thrust = 1.0 - (dy * 0.02); // >1 if moving up, <1 if moving down
                const flareLen = 20 * Math.max(0.5, Math.min(2.0, thrust)) + Math.random() * 5;

                // Draw Engine Flare
                ctx.fillStyle = player.config.color;
                ctx.globalAlpha = 0.6;
                ctx.shadowBlur = 10; ctx.shadowColor = player.config.color;
                ctx.beginPath();
                ctx.moveTo(-5, player.radius * 0.8);
                ctx.lineTo(0, player.radius * 0.8 + flareLen);
                ctx.lineTo(5, player.radius * 0.8);
                ctx.fill();
                ctx.globalAlpha = 1.0;
                
                // Draw Ship Body
                ctx.shadowBlur = 15; 
                ctx.shadowColor = player.config.color; 
                ctx.fillStyle = player.config.color; 
                
                ctx.beginPath();
                if (player.config.id === 0) { 
                    ctx.moveTo(0, -player.radius); ctx.lineTo(player.radius, player.radius); ctx.lineTo(0, player.radius * 0.7); ctx.lineTo(-player.radius, player.radius); ctx.fill();
                    ctx.fillStyle = "rgba(255,255,255,0.8)"; ctx.beginPath(); ctx.moveTo(0, -player.radius * 0.2); ctx.lineTo(5, player.radius * 0.2); ctx.lineTo(0, player.radius * 0.4); ctx.lineTo(-5, player.radius * 0.2); ctx.fill();
                } 
                else if (player.config.id === 1) { 
                    ctx.moveTo(0, -player.radius); ctx.lineTo(5, -5); ctx.lineTo(player.radius, -10); ctx.lineTo(player.radius * 0.8, player.radius); ctx.lineTo(0, player.radius * 0.5); ctx.lineTo(-player.radius * 0.8, player.radius); ctx.lineTo(-player.radius, -10); ctx.lineTo(-5, -5); ctx.fill();
                    ctx.fillStyle = "#fff"; ctx.fillRect(15, -15, 2, 10); ctx.fillRect(-17, -15, 2, 10);
                } 
                else if (player.config.id === 2) { 
                    ctx.moveTo(-10, -player.radius); ctx.lineTo(10, -player.radius); ctx.lineTo(player.radius, -5); ctx.lineTo(player.radius, 15); ctx.lineTo(15, player.radius); ctx.lineTo(-15, player.radius); ctx.lineTo(-player.radius, 15); ctx.lineTo(-player.radius, -5); ctx.fill();
                    ctx.strokeStyle = "rgba(0,0,0,0.5)"; ctx.lineWidth = 2; ctx.stroke();
                } 
                else if (player.config.id === 3) { 
                    ctx.moveTo(0, -player.radius); ctx.lineTo(5, -10); ctx.lineTo(player.radius, -5); ctx.lineTo(player.radius * 0.6, 10); ctx.lineTo(player.radius, player.radius); ctx.lineTo(0, player.radius * 0.5); ctx.lineTo(-player.radius, player.radius); ctx.lineTo(-player.radius * 0.6, 10); ctx.lineTo(-player.radius, -5); ctx.lineTo(-5, -10); ctx.fill();
                    ctx.strokeStyle = "#fff"; ctx.lineWidth = 1; ctx.beginPath(); ctx.moveTo(0, -player.radius); ctx.lineTo(0, 10); ctx.stroke();
                }
                
                // Engine Core Flicker
                ctx.fillStyle = "#ffffff"; 
                ctx.beginPath(); 
                const flicker = Math.random() * 2;
                ctx.arc(0, player.radius * 0.8, 4 + flicker, 0, Math.PI*2); 
                ctx.fill();
                
                ctx.restore(); 
                ctx.shadowBlur = 0;

                if (player.shieldHp > 0) { ctx.strokeStyle = `rgba(0, 255, 255, ${player.shieldHp/3 + 0.2})`; ctx.lineWidth = 3; ctx.beginPath(); ctx.arc(player.x, player.y, player.radius + 10, 0, Math.PI*2); ctx.stroke(); }
                bullets.forEach(b => b.draw()); enemies.forEach(e => e.draw()); particles.forEach(p => p.draw()); floatingTexts.forEach(t => t.draw());
            }
            ctx.restore(); requestAnimationFrame(() => { update(); draw(); });
        }

        function createExplosion(x, y, color, count, isSpark) { for(let i=0; i<count; i++) { particles.push(new Particle(x, y, color, isSpark ? 'spark' : 'spark')); } }
        function triggerShake(amount) { shake = amount; }

        function updateHUD() {
            document.getElementById('score-display').innerText = score;
            document.getElementById('coin-display').innerText = SaveSystem.data.coins;
            const hpPercent = Math.max(0, (player.hp / player.maxHp) * 100);
            const hpBar = document.getElementById('health-bar');
            hpBar.style.width = hpPercent + '%';
            hpBar.className = hpPercent < 30 ? "absolute top-0 left-0 h-full bg-gradient-to-r from-red-600 to-red-400 transition-all duration-200 animate-pulse" : "absolute top-0 left-0 h-full bg-gradient-to-r from-green-600 to-green-400 transition-all duration-200";

            const statusContainer = document.getElementById('status-hud');
            statusContainer.innerHTML = '';
            if (player.scoreMult > 1) { const mSecs = Math.ceil(player.scoreMultTimer/60); statusContainer.innerHTML += `<div class="status-icon text-yellow-400 border-yellow-400 animate-pulse"><span class="mr-2">X2</span> BONUS: ${mSecs}s</div>`; }
            if (player.shieldHp > 0) { statusContainer.innerHTML += `<div class="status-icon text-cyan-400 border-cyan-400"><span class="mr-2">üõ°Ô∏è</span> SHIELD: ${player.shieldHp}</div>`; }
            if (player.laserTimer > 0) { const secs = Math.ceil(player.laserTimer/60); statusContainer.innerHTML += `<div class="status-icon text-pink-400 border-pink-400"><span class="mr-2">‚ö°</span> LASER: ${secs}s</div>`; }

            const shieldBtn = document.getElementById('btn-shield');
            const laserBtn = document.getElementById('btn-laser');
            const regenBtn = document.getElementById('btn-regen');
            document.getElementById('count-shield').innerText = SaveSystem.data.inventory.shield;
            document.getElementById('count-laser').innerText = SaveSystem.data.inventory.laser;
            document.getElementById('count-regen').innerText = SaveSystem.data.inventory.regen;
            if (SaveSystem.data.inventory.shield > 0) shieldBtn.classList.add('active'); else shieldBtn.classList.remove('active');
            if (SaveSystem.data.inventory.laser > 0) laserBtn.classList.add('active'); else laserBtn.classList.remove('active');
            if (SaveSystem.data.inventory.regen > 0) regenBtn.classList.add('active'); else regenBtn.classList.remove('active');

            const comboEl = document.getElementById('combo-container');
            const comboFill = document.getElementById('combo-bar-fill');
            const comboCount = document.getElementById('combo-count');
            if (player.combo > 1) { comboEl.classList.add('active'); comboCount.innerText = `COMBO x${player.combo}`; comboFill.style.width = (player.comboTimer / 180 * 100) + '%'; } else { comboEl.classList.remove('active'); }
        }

        function gameOver() {
            currentState = GAME_STATE.GAMEOVER;
            SoundManager.stopMusic();
            const earnedCoins = Math.floor(score / 10);
            SaveSystem.data.coins += earnedCoins;
            if (score > SaveSystem.data.highScore) SaveSystem.data.highScore = score;
            SaveSystem.save(); 
            document.getElementById('final-score').innerText = score;
            document.getElementById('coins-earned').innerText = earnedCoins;
            setTimeout(() => { game.hideAllScreens(); document.getElementById('gameover-screen').classList.add('active'); }, 1000);
        }

        const game = {
            init: () => {
                SaveSystem.load();
                setTimeout(() => { document.getElementById('boot-screen').classList.remove('active'); game.openMenu(); }, 2200);
                const unlockAudio = () => { SoundManager.init(); document.body.removeEventListener('click', unlockAudio); document.body.removeEventListener('touchstart', unlockAudio); };
                document.body.addEventListener('click', unlockAudio);
                document.body.addEventListener('touchstart', unlockAudio);
                draw();
            },
            
            notify: (msg, type = 'success') => {
                const container = document.getElementById('notifications');
                const el = document.createElement('div');
                el.className = `notification ${type === 'error' ? 'notify-error' : 'notify-success'}`;
                el.innerText = msg;
                container.appendChild(el);
                if (type === 'error') SoundManager.playShieldHit(); else SoundManager.playUI(); 
                setTimeout(() => { el.remove(); }, 3000);
            },

            exit: () => { SoundManager.playUI(); SoundManager.stopMusic(); game.hideAllScreens(); document.getElementById('shutdown-screen').classList.add('active'); },
            
            updateVolume: (type) => {
                if(type === 'sfx') {
                    SaveSystem.data.settings.sfxVolume = parseFloat(document.getElementById('sfx-slider').value);
                    document.getElementById('sfx-vol-val').innerText = Math.round(SaveSystem.data.settings.sfxVolume * 100) + '%';
                } else if(type === 'music') {
                    SaveSystem.data.settings.musicVolume = parseFloat(document.getElementById('music-slider').value);
                    document.getElementById('music-vol-val').innerText = Math.round(SaveSystem.data.settings.musicVolume * 100) + '%';
                    SoundManager.updateVolumes();
                }
                SaveSystem.save();
            },
            
            openMenu: () => { SoundManager.playUI(); currentState = GAME_STATE.MENU; game.hideAllScreens(); document.getElementById('menu-screen').classList.add('active'); document.getElementById('high-score-display').innerText = `HIGH SCORE: ${SaveSystem.data.highScore}`; document.getElementById('hud').classList.add('hidden'); },

            start: () => {
                SoundManager.init(); SoundManager.playUI(); currentState = GAME_STATE.PLAYING; score = 0; level = 1; enemies = []; bullets = []; particles = []; drops = []; floatingTexts = []; swarmTimer = 0;
                
                const shipId = SaveSystem.data.currentShip;
                const shipLevel = SaveSystem.data.shipLevels[shipId];
                player.config = SHIPS.find(s => s.id === shipId) || SHIPS[0];
                player.maxHp = player.config.health + (shipLevel - 1) * 50; player.hp = player.maxHp; player.fireRate = Math.max(2, player.config.fireRate - (shipLevel - 1) * 3);
                player.damage = player.config.damage + (shipLevel - 1); // DYNAMIC DAMAGE
                player.x = width / 2; player.y = height - 100; player.targetX = player.x; player.targetY = player.y;
                player.shieldHp = 0; player.laserTimer = 0; player.scoreMult = 1; player.scoreMultTimer = 0; player.combo = 0; player.comboTimer = 0;

                game.hideAllScreens(); document.getElementById('hud').classList.remove('hidden'); updateHUD();
            },

            activatePowerup: (type) => {
                if (currentState !== GAME_STATE.PLAYING && currentState !== GAME_STATE.PAUSED) return;
                if (SaveSystem.data.inventory[type] <= 0) return;
                const lvl = SaveSystem.data.powerupLevels[type] || 1;
                if (type === 'shield') { player.shieldHp += (3 + (lvl - 1) * 2); createExplosion(player.x, player.y, '#00ffff', 10); SoundManager.playPowerup(); floatingTexts.push(new FloatingText(player.x, player.y, "SHIELD UP!", '#00ffff', 25)); } 
                else if (type === 'laser') { player.laserTimer = (600 + (lvl - 1) * 300); createExplosion(player.x, player.y, '#ff00ff', 10); SoundManager.playPowerup(); floatingTexts.push(new FloatingText(player.x, player.y, "LASER ON!", '#ff00ff', 25)); }
                else if (type === 'regen') { 
                    const heal = 50 + (lvl - 1) * 25; 
                    player.hp = Math.min(player.maxHp, player.hp + heal); 
                    createExplosion(player.x, player.y, '#00ff00', 10); SoundManager.playPowerup(); 
                    floatingTexts.push(new FloatingText(player.x, player.y, `REPAIR +${heal}`, '#00ff00', 25)); 
                }
                SaveSystem.data.inventory[type]--; updateHUD();
            },

            levelUp: () => {
                level++; const notif = document.getElementById('level-notification'); notif.innerText = `LEVEL ${level}`; notif.classList.add('show'); SoundManager.playPowerup(); setTimeout(() => notif.classList.remove('show'), 2000);
            },
            togglePause: () => {
                SoundManager.playUI();
                if (currentState === GAME_STATE.PLAYING) { currentState = GAME_STATE.PAUSED; document.getElementById('pause-screen').classList.add('active'); SoundManager.stopMusic(); } 
                else if (currentState === GAME_STATE.PAUSED) { currentState = GAME_STATE.PLAYING; document.getElementById('pause-screen').classList.remove('active'); if(SaveSystem.data.settings.musicVolume > 0) SoundManager.startMusic(); }
            },

            quitToMenu: () => { SoundManager.playUI(); game.openMenu(); },
            openShop: () => { SoundManager.playUI(); game.hideAllScreens(); document.getElementById('shop-screen').classList.add('active'); game.renderShop(); },
            openSettings: () => { SoundManager.playUI(); game.hideAllScreens(); document.getElementById('settings-screen').classList.add('active'); },

            renderShop: () => {
                document.getElementById('shop-coins').innerText = SaveSystem.data.coins;
                const shipContainer = document.getElementById('ships-container'); shipContainer.innerHTML = '';
                SHIPS.forEach(ship => {
                    const isUnlocked = SaveSystem.data.unlockedShips.includes(ship.id);
                    const isEquipped = SaveSystem.data.currentShip === ship.id;
                    const shipLvl = SaveSystem.data.shipLevels[ship.id] || 1;
                    const el = document.createElement('div'); el.className = `shop-item ${isEquipped ? 'selected' : ''} ${!isUnlocked ? 'locked' : ''}`;
                    const currentFr = Math.max(2, ship.fireRate - (shipLvl - 1) * 3); const currentHp = ship.health + (shipLvl - 1) * 50;
                    const currentDmg = ship.damage + (shipLvl - 1);
                    const frPct = ((18 - currentFr) / 16) * 100; const hpPct = (currentHp / 350) * 100;
                    const dmgPct = (currentDmg / 6) * 100; // Adjusted max reference

                    let actionBtn = '';
                    if (isUnlocked) {
                        const upgradeCost = ship.upgradeCost * shipLvl;
                        const canUpgrade = SaveSystem.data.coins >= upgradeCost && shipLvl < ship.maxLevel;
                        const upgradeText = shipLvl >= ship.maxLevel ? "MAX LEVEL" : `UPGRADE (${upgradeCost})`;
                        let equipBtn = isEquipped ? `<div class="text-green-400 font-bold text-center border border-green-500 py-1 rounded bg-green-900/20 text-xs mb-2">ACTIVE</div>` : `<button class="w-full bg-cyan-900/40 border border-cyan-500 text-cyan-400 py-1 mb-2 rounded hover:bg-cyan-500 hover:text-white transition-colors text-xs" onclick="game.equipShip(${ship.id})">EQUIP</button>`;
                        let upgradeBtn = shipLvl >= ship.maxLevel ? `<div class="text-gray-500 text-center text-xs py-1">MAXED OUT</div>` : `<button class="w-full ${canUpgrade ? 'bg-yellow-600 hover:bg-yellow-500 text-white' : 'bg-gray-800 text-gray-500'} py-1 rounded text-xs" onclick="game.upgradeShip(${ship.id})" ${!canUpgrade ? 'disabled' : ''}>${upgradeText}</button>`;
                        actionBtn = equipBtn + upgradeBtn;
                    } else {
                        const canBuy = SaveSystem.data.coins >= ship.cost;
                        actionBtn = `<button class="w-full ${canBuy ? 'bg-yellow-600 hover:bg-yellow-500 text-white' : 'bg-gray-800 text-gray-500'} py-2 mt-3 rounded transition-colors font-bold" onclick="game.buyShip(${ship.id})" ${!canBuy ? 'disabled' : ''}>UNLOCK: ${ship.cost}</button>`;
                    }
                    el.innerHTML = `<div class="flex items-center mb-2"><div class="w-10 h-10 rounded bg-gray-900 border border-gray-700 mr-3 flex items-center justify-center"><svg width="24" height="24" viewBox="0 0 50 50">${ship.svg}</svg></div><div><div class="text-white font-bold text-sm leading-none">${ship.name}</div><div class="text-xs text-yellow-400">LVL ${shipLvl}</div></div></div><div class="mb-2 space-y-1"><div class="stat-row"><div class="stat-label">DMG</div><div class="stat-track"><div class="stat-fill" style="width: ${dmgPct}%"></div></div></div><div class="stat-row"><div class="stat-label">ROF</div><div class="stat-track"><div class="stat-fill" style="width: ${frPct}%"></div></div></div><div class="stat-row"><div class="stat-label">HULL</div><div class="stat-track"><div class="stat-fill" style="width: ${hpPct}%"></div></div></div></div><div class="text-xs text-gray-400 mb-2 h-8 leading-tight overflow-hidden">${ship.desc}</div>${actionBtn}`;
                    shipContainer.appendChild(el);
                });

                const puContainer = document.getElementById('powerups-container'); puContainer.innerHTML = '';
                POWERUPS.forEach(pu => {
                    const count = SaveSystem.data.inventory[pu.id] || 0;
                    const puLvl = SaveSystem.data.powerupLevels[pu.id] || 1;
                    const el = document.createElement('div'); el.className = `shop-item ${count > 0 ? 'owned-pu' : ''}`;
                    const canAffordStock = SaveSystem.data.coins >= pu.cost;
                    const upgradeCost = pu.upgradeCost * puLvl;
                    const canUpgrade = SaveSystem.data.coins >= upgradeCost && puLvl < pu.maxLevel;
                    const upgradeText = puLvl >= pu.maxLevel ? "MAX" : `UPG (${upgradeCost})`;
                    el.innerHTML = `<div class="flex justify-between items-start mb-1"><div class="text-white font-bold text-sm">${pu.name} <span class="text-yellow-400 text-xs ml-1">LVL ${puLvl}</span></div><div class="text-xl">${pu.icon}</div></div><div class="text-xs text-gray-400 mb-2 h-8 leading-tight">${pu.desc}</div><div class="text-sm text-purple-400 font-bold mb-2">STOCK: ${count}</div><div class="flex gap-2"><button class="flex-1 ${canAffordStock ? 'bg-purple-900/40 border border-purple-500 hover:bg-purple-500 text-purple-100' : 'bg-gray-800 text-gray-500'} py-1 rounded text-xs" onclick="game.buyPowerup('${pu.id}')" ${!canAffordStock ? 'disabled' : ''}>BUY (${pu.cost})</button><button class="flex-1 ${canUpgrade ? 'bg-yellow-600 hover:bg-yellow-500 text-white' : 'bg-gray-800 text-gray-500'} py-1 rounded text-xs" onclick="game.upgradePowerup('${pu.id}')" ${!canUpgrade || puLvl >= pu.maxLevel ? 'disabled' : ''}>${upgradeText}</button></div>`;
                    puContainer.appendChild(el);
                });
            },

            buyShip: (id) => {
                const ship = SHIPS.find(s => s.id === id);
                if (SaveSystem.data.coins >= ship.cost) { SoundManager.playPowerup(); SaveSystem.data.coins -= ship.cost; SaveSystem.data.unlockedShips.push(id); SaveSystem.save(); game.renderShop(); game.notify(`${ship.name} UNLOCKED`, 'success'); } else { game.notify("INSUFFICIENT CREDITS", 'error'); }
            },
            equipShip: (id) => { SoundManager.playUI(); SaveSystem.data.currentShip = id; SaveSystem.save(); game.renderShop(); },
            upgradeShip: (id) => {
                const ship = SHIPS.find(s => s.id === id); const currentLvl = SaveSystem.data.shipLevels[id]; const cost = ship.upgradeCost * currentLvl;
                if (SaveSystem.data.coins >= cost && currentLvl < ship.maxLevel) { SoundManager.playPowerup(); SaveSystem.data.coins -= cost; SaveSystem.data.shipLevels[id]++; SaveSystem.save(); game.renderShop(); game.notify("SHIP UPGRADED", 'success'); } 
                else { if(currentLvl >= ship.maxLevel) game.notify("MAX LEVEL REACHED", 'error'); else game.notify("INSUFFICIENT CREDITS", 'error'); }
            },
            buyPowerup: (id) => {
                const pu = POWERUPS.find(p => p.id === id);
                if (SaveSystem.data.coins >= pu.cost) { SoundManager.playPowerup(); SaveSystem.data.coins -= pu.cost; SaveSystem.data.inventory[id]++; SaveSystem.save(); game.renderShop(); game.notify(`${pu.name} ACQUIRED`, 'success'); } else { game.notify("INSUFFICIENT CREDITS", 'error'); }
            },
            upgradePowerup: (id) => {
                const pu = POWERUPS.find(p => p.id === id); const currentLvl = SaveSystem.data.powerupLevels[id]; const cost = pu.upgradeCost * currentLvl;
                if (SaveSystem.data.coins >= cost && currentLvl < pu.maxLevel) { SoundManager.playPowerup(); SaveSystem.data.coins -= cost; SaveSystem.data.powerupLevels[id]++; SaveSystem.save(); game.renderShop(); game.notify("UPGRADE SUCCESSFUL", 'success'); } 
                else { if(currentLvl >= pu.maxLevel) game.notify("MAX LEVEL REACHED", 'error'); else game.notify("INSUFFICIENT CREDITS", 'error'); }
            },
            hideAllScreens: () => { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); }
        };

        window.addEventListener('touchstart', e => { 
            touchActive = true; 
            if(currentState === GAME_STATE.PLAYING && e.target.tagName !== 'BUTTON' && !e.target.closest('button')) { 
                player.targetX = e.touches[0].clientX; 
                // Touch Offset: Place ship slightly above finger to improve visibility
                player.targetY = e.touches[0].clientY - 50; 
            } 
        }, {passive: false});

        window.addEventListener('touchmove', e => { 
            if(currentState === GAME_STATE.PLAYING) { 
                e.preventDefault(); 
                player.targetX = e.touches[0].clientX; 
                player.targetY = e.touches[0].clientY - 50; 
            } 
        }, {passive: false});
        
        window.addEventListener('touchend', () => touchActive = false);
        window.addEventListener('mousemove', e => { 
            if(currentState === GAME_STATE.PLAYING && !touchActive) { 
                player.targetX = e.clientX; 
                player.targetY = e.clientY; 
            } 
        });

        game.init();

    </script>
</body>
</html>
